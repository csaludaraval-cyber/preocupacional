
/**
 * @file Firestore Security Rules
 * @description Este conjunto de reglas implementa un modelo de control de acceso basado en roles para la gestión de empresas,
 * solicitantes, exámenes, cotizaciones y solicitudes públicas. El acceso se controla principalmente mediante dos
 * conceptos: el rol de 'Administrador' y la 'propiedad' de un documento.
 *
 * Filosofía Central:
 * 1.  **Seguridad por Defecto:** Nadie tiene acceso a nada a menos que una regla lo permita explícitamente.
 * 2.  **Rol de Administrador:** Un usuario es administrador si su UID existe como un documento en la colección `/roles_admin`.
 *     Este rol otorga acceso de lectura y escritura a casi toda la base de datos.
 * 3.  **Propiedad del Documento:** Los usuarios estándar solo pueden ver y modificar los datos que les pertenecen directamente
 *     (por ejemplo, su propio perfil de solicitante).
 * 4.  **Acceso Público Controlado:** La colección `/solicitudes_publicas` permite que cualquiera escriba (envíe una solicitud),
 *     pero solo los administradores pueden leer o gestionar dichas solicitudes, protegiendo la privacidad.
 * 5.  **Denormalización para Seguridad:** Datos como `empresaData` se almacenan directamente en las cotizaciones para evitar
 *     la necesidad de hacer llamadas `get()` adicionales en las reglas, lo cual es más eficiente y seguro.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Empresas: Solo los administradores pueden leer o modificar los datos de las empresas.
     * @path /empresas/{empresaId}
     * @principle Acceso exclusivo para administradores.
     */
    match /empresas/{empresaId} {
      allow read, write: if isSignedIn() && isAdmin();
    }

    /**
     * @description Solicitantes: Un usuario solo puede gestionar su propio perfil. Los administradores pueden verlos todos.
     * @path /solicitantes/{solicitanteId}
     * @principle Propiedad del documento y supervisión del administrador.
     */
    match /solicitantes/{solicitanteId} {
      // Un usuario puede ver su propio perfil, o un admin puede ver cualquiera.
      allow get: if isSignedIn() && (isOwner(solicitanteId) || isAdmin());
      // Solo los admins pueden listar todos los perfiles.
      allow list: if isSignedIn() && isAdmin();
      // Un usuario autenticado puede crear su PROPIO perfil (esencial para el registro).
      allow create: if isSignedIn() && isOwner(solicitanteId);
      // Un usuario puede actualizar su propio perfil, o un admin puede actualizar cualquiera.
      allow update: if isSignedIn() && (isOwner(solicitanteId) || isAdmin());
      // Solo los admins pueden eliminar perfiles.
      allow delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Catálogo de Exámenes: Público para lectura, restringido para escritura.
     * @path /examenes/{examenId}
     * @principle Permite que la app muestre los exámenes a cualquiera, pero solo los admins los gestionan.
     */
    match /examenes/{examenId} {
      // Cualquiera puede leer la lista de exámenes (incluso sin estar autenticado).
      allow get, list: if true;
      // Solo los administradores pueden crear, actualizar o eliminar exámenes.
      allow create, update, delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Cotizaciones: Los administradores tienen control total.
     * @path /cotizaciones/{cotizacionId}
     * @principle Los administradores gestionan todo el ciclo de vida de las cotizaciones.
     */
    match /cotizaciones/{cotizacionId} {
      // Cualquier usuario autenticado puede, en teoría, recibir una cotización y verla.
      allow get, list: if isSignedIn();
      // Solo un administrador puede crear una cotización.
      allow create: if isSignedIn() && isAdmin();
      // Solo los administradores pueden actualizar (cambiar estado) o eliminar cotizaciones.
      allow update, delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Gestión de Roles de Administrador.
     * @path /roles_admin/{userId}
     * @principle La existencia de un documento aquí convierte a un usuario en administrador.
     */
    match /roles_admin/{userId} {
      // Solo los administradores pueden ver la lista de otros administradores.
      allow get, list: if isSignedIn() && isAdmin();
      // Un usuario puede crear su propio documento de rol. Esto es clave para el flujo de "crear primer admin".
      // Aunque cualquiera puede intentarlo, solo tendrá efecto si se usa en conjunto con la UI de creación de admin.
      allow create: if isSignedIn() && request.auth.uid == userId;
      // Solo un admin puede eliminar a otro admin.
      allow update, delete: if isSignedIn() && isAdmin();
    }
    
    /**
     * @description Solicitudes Públicas: Punto de entrada para clientes no autenticados.
     * @path /solicitudes_publicas/{solicitudId}
     * @principle Escritura pública, lectura y gestión privadas (solo para admins).
     */
    match /solicitudes_publicas/{solicitudId} {
      // Cualquiera puede enviar una solicitud (crear un documento).
      allow create: if true;
      // Solo los administradores pueden leer, listar, actualizar o eliminar las solicitudes enviadas.
      allow read, list, update, delete: if isSignedIn() && isAdmin();
    }

    // --- Funciones de Ayuda (Helpers) ---

    /**
     * @description Verifica si el usuario ha iniciado sesión.
     * @returns {bool} True si el usuario está autenticado.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Verifica si el usuario que hace la petición es el dueño del documento.
     * @param {string} userId - El ID del usuario a comparar con el ID del documento o recurso.
     * @returns {bool} True si los IDs coinciden.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Verifica si el usuario es un administrador.
     * La lógica es simple: si existe un documento en la colección 'roles_admin'
     * con el ID del usuario autenticado, entonces es administrador.
     * @returns {bool} True si el usuario tiene el rol de administrador.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
  }
}
